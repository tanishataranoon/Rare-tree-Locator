{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link rel="stylesheet" href="{% static 'CSS/homepage.css' %}">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>

<body>

  {% include 'Common/header.html' %}

  <!-- ===== DIAGONAL SLIDESHOW SECTION ===== -->
  <div class="main-container">
    <div class="slideshow">
      <div class="slide active" style="background-image: url('{% static "images/p_1.jpg" %}');"></div>
      <div class="slide" style="background-image: url('{% static "images/p_2.jpg" %}');"></div>
      <div class="slide" style="background-image: url('{% static "images/p_3.jpg" %}');"></div>
    </div>

    <div class="right-side">
      <div>
        <h1>Discover Rare Trees Around the World</h1>
        <p>
          Join our community in documenting and preserving the world's most extraordinary trees.
          Every discovery helps protect biodiversity for future generations.
        </p>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <section class="search-section">
    <div class="container">
      <div class="search-bar">
        <span class="icon">üîç</span>
        <input type="text" placeholder="Search for trees by name, location, or type...">
      </div>
    </div>
  </section>

  <!-- Map Section -->
  <section class="map-section">
    <div class="map-content">
      <h2>Tree Locations Near You</h2>
      <div class="map-content">
        üìç
        <h3>Interactive Map</h3>
        <p>Discover rare trees in your area</p>
      </div>

      <!-- Leaflet Map -->
      <div id="map" style="height: 400px; margin-top: 20px;"></div>

      <!-- Tree Form -->
      <div id="map-form-container" style="margin-top: 20px;">
        <h3>Add a New Tree</h3>
        <form method="POST" id="tree-form">{% csrf_token %}
          <input type="text" name="street_name" placeholder="Street / Local Name" required><br>
          <input type="text" name="scientific_name" placeholder="Scientific Name"><br>
          <input type="text" name="habitat" placeholder="Habitat"><br>
          <textarea name="description" placeholder="Description"></textarea><br>
          <input type="text" name="rarity_status" placeholder="Rarity Status"><br>
          <input type="number" step="0.01" name="height_m" placeholder="Height in meters"><br>
          <input type="number" name="age_estimate" placeholder="Age estimate"><br>
          <input type="hidden" id="id_latitude" name="latitude">
          <input type="hidden" id="id_longitude" name="longitude">
          <button type="submit">Submit Tree</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Featured Trees Grid -->
  <section class="featured-section">
    <div class="featured-container">
      <div class="text-center mb-8">
        <h2>Featured Trees</h2>
        <p>Explore some of the most remarkable trees recently discovered by our community</p>
      </div>

      <div class="tree-grid" id="featured-trees">
        <!-- Tree cards will be injected here via JS -->
      </div>

      <div class="text-center mt-6">
        <button class="btn-outline" onclick="navigate('trees')">View All Trees</button>
      </div>
    </div>
  </section>

  {% include 'Common/footer.html' %}

  <!-- JS should load at the end of body -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="{% static 'JS/homepage.js' %}"></script>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const map = L.map('map').setView([23.8103, 90.4125], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // === Load all trees from Django API ===
    fetch("{% url 'get_trees_json' %}")
      .then(res => res.json())
      .then(trees => {
        console.log("Loaded trees:", trees);
        trees.forEach(tree => {
          const lat = parseFloat(tree.latitude);
          const lng = parseFloat(tree.longitude);
          if (!isNaN(lat) && !isNaN(lng)) {
            const popupContent = `
  <div style="text-align:center; max-width:150px;">
    <b>${tree.street_name}</b><br>
    ${tree.description ? `<small>${tree.description}</small><br>` : ""}
    ${tree.image_url ? `<img src="${tree.image_url}" alt="${tree.street_name}"
        style="width:120px; height:auto; border-radius:8px; margin-top:5px;">` : ""}
  </div>
`;

L.marker([lat, lng])
  .addTo(map)
  .bindPopup(popupContent);

          }
        });
      })
      .catch(err => console.error("Error loading trees:", err));

    // === Click to add marker ===
    let marker;
    map.on('click', function (e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lng]).addTo(map)
        .bindPopup(`Lat: ${lat}, Lng: ${lng}`).openPopup();
      document.getElementById('id_latitude').value = lat;
      document.getElementById('id_longitude').value = lng;
    });

    // === AJAX form submission ===
    const form = document.getElementById('tree-form');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const data = new FormData(form);

      fetch("{% url 'add_tree_ajax' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
        body: data
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("Tree added successfully!");
            L.marker([data.latitude, data.longitude])
              .addTo(map)
              .bindPopup(`<b>${data.street_name}</b><br>${data.description || ''}`)
              .openPopup();
            form.reset();
            if (marker) map.removeLayer(marker);
          } else {
            alert("Error: " + data.error);
          }
        })
        .catch(err => console.error("Error adding tree:", err));
    });
  });
  </script>

</body>
</html>
